<div class="admin-dashboard-container">
  <div class="page-header">
    <h2><mat-icon>admin_panel_settings</mat-icon> Admin Dashboard</h2>
    <p class="subtitle">Manage users, balances, and view system-wide analytics</p>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    <mat-icon>error_outline</mat-icon>
    {{ error }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>
  <div *ngIf="success" class="alert alert-success alert-dismissible fade show" role="alert">
    <mat-icon>check_circle_outline</mat-icon>
    {{ success }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <!-- Global Summary View -->
  <div *ngIf="currentView === 'summary'">
    <!-- Summary Statistics -->
    <div *ngIf="globalSummary" class="summary-cards">
      <mat-card class="summary-card users-card">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>people</mat-icon>
          </div>
          <div class="card-details">
            <h6>Total Users</h6>
            <h3>{{ globalSummary.totalUsers }}</h3>
            <p class="card-label">{{ globalSummary.activeUsers }} active</p>
          </div>
        </mat-card-content>
      </mat-card>
      
      <mat-card class="summary-card balance-card">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>account_balance</mat-icon>
          </div>
          <div class="card-details">
            <h6>Total Balance</h6>
            <h3>${{ globalSummary.totalBalance | number:'1.2-2' }}</h3>
            <p class="card-label">Avg: ${{ globalSummary.averageBalance | number:'1.2-2' }}</p>
          </div>
        </mat-card-content>
      </mat-card>
      
      <mat-card class="summary-card admin-card">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>account_circle</mat-icon>
          </div>
          <div class="card-details">
            <h6>Admin Balance</h6>
            <h3>${{ globalSummary.adminBalance | number:'1.2-2' }}</h3>
            <p class="card-label">{{ globalSummary.adminUsername }}</p>
          </div>
        </mat-card-content>
      </mat-card>
      
      <mat-card class="summary-card transactions-card">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>receipt_long</mat-icon>
          </div>
          <div class="card-details">
            <h6>Transactions</h6>
            <h3>{{ globalSummary.totalTransactions }}</h3>
            <p class="card-label">Total processed</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>


    <!-- All Users Table -->
    <mat-card class="data-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>group</mat-icon>
          All Users
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-responsive">
          <table mat-table [dataSource]="allUsers" class="users-table">
            <ng-container matColumnDef="username">
              <th mat-header-cell *matHeaderCellDef>Username</th>
              <td mat-cell *matCellDef="let user">{{ user.username }}</td>
            </ng-container>
            
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let user">{{ user.email }}</td>
            </ng-container>
            
            <ng-container matColumnDef="role">
              <th mat-header-cell *matHeaderCellDef>Role</th>
              <td mat-cell *matCellDef="let user">
                <span class="role-badge" [ngClass]="user.role === 'admin' ? 'admin-role' : ''">{{ user.role }}</span>
              </td>
            </ng-container>
            
            <ng-container matColumnDef="balance">
              <th mat-header-cell *matHeaderCellDef class="text-end">Balance</th>
              <td mat-cell *matCellDef="let user" class="text-end">
                <span class="balance-amount">${{ user.walletBalance | number:'1.2-2' }}</span>
              </td>
            </ng-container>
            
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let user">
                <span class="status-badge" [ngClass]="user.isActive ? 'active' : 'inactive'">
                  {{ user.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
            </ng-container>
            
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let user">
                <button mat-icon-button color="primary" (click)="viewUserNextLevel(user)" matTooltip="View next level">
                  <mat-icon>people</mat-icon>
                </button>
                <button mat-icon-button color="accent" (click)="viewUserHierarchy(user)" matTooltip="View hierarchy">
                  <mat-icon>account_tree</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="showCreditFormForUser(user._id)" matTooltip="Credit balance">
                  <mat-icon>attach_money</mat-icon>
                </button>
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="['username', 'email', 'role', 'balance', 'status', 'actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['username', 'email', 'role', 'balance', 'status', 'actions'];" class="user-row"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Next Level Users View -->
  <div *ngIf="currentView === 'users'">
    <button mat-raised-button color="primary" class="mb-3" (click)="backToSummary()">
      <mat-icon>arrow_back</mat-icon>
      Back to Summary
    </button>

    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>people</mat-icon>
          Next Level Users of {{ selectedUser?.username }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="user-info-grid">
          <div class="info-item">
            <mat-icon>person</mat-icon>
            <div>
              <span class="label">User</span>
              <span class="value">{{ selectedUser?.username }} ({{ selectedUser?.email }})</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>account_balance_wallet</mat-icon>
            <div>
              <span class="label">Balance</span>
              <span class="value">${{ selectedUser?.walletBalance | number:'1.2-2' }}</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>group</mat-icon>
            <div>
              <span class="label">Direct Children</span>
              <span class="value">{{ nextLevelUsers.length }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div *ngIf="loading" class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading users...</p>
    </div>

    <mat-card *ngIf="!loading && nextLevelUsers.length > 0" class="data-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>group</mat-icon>
          Children ({{ nextLevelUsers.length }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-responsive">
          <table mat-table [dataSource]="nextLevelUsers" class="users-table">
            <ng-container matColumnDef="username">
              <th mat-header-cell *matHeaderCellDef>Username</th>
              <td mat-cell *matCellDef="let user">{{ user.username }}</td>
            </ng-container>
            
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let user">{{ user.email }}</td>
            </ng-container>
            
            <ng-container matColumnDef="balance">
              <th mat-header-cell *matHeaderCellDef class="text-end">Balance</th>
              <td mat-cell *matCellDef="let user" class="text-end">
                <span class="balance-amount">${{ user.walletBalance | number:'1.2-2' }}</span>
              </td>
            </ng-container>
            
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let user">
                <span class="status-badge" [ngClass]="user.isActive ? 'active' : 'inactive'">
                  {{ user.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
            </ng-container>
            
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let user">
                <button mat-icon-button color="accent" (click)="showCreditFormForUser(user._id)" matTooltip="Credit balance">
                  <mat-icon>attach_money</mat-icon>
                </button>
                <button mat-icon-button color="primary" (click)="viewUserHierarchy(user)" matTooltip="View hierarchy">
                  <mat-icon>account_tree</mat-icon>
                </button>
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="['username', 'email', 'balance', 'status', 'actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['username', 'email', 'balance', 'status', 'actions'];" class="user-row"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card *ngIf="!loading && nextLevelUsers.length === 0" class="no-data-card">
      <mat-card-content>
        <mat-icon class="no-data-icon">inbox</mat-icon>
        <h4>No Direct Children</h4>
        <p>This user doesn't have any direct children yet.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Hierarchy View -->
  <div *ngIf="currentView === 'hierarchy'">
    <button mat-raised-button color="primary" class="mb-3" (click)="backToSummary()">
      <mat-icon>arrow_back</mat-icon>
      Back to Summary
    </button>

    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>account_tree</mat-icon>
          Complete Hierarchy of {{ selectedUser?.username }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="user-info-grid">
          <div class="info-item">
            <mat-icon>person</mat-icon>
            <div>
              <span class="label">User</span>
              <span class="value">{{ hierarchyData?.user?.username }} ({{ hierarchyData?.user?.email }})</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>account_balance_wallet</mat-icon>
            <div>
              <span class="label">Balance</span>
              <span class="value">${{ hierarchyData?.user?.walletBalance | number:'1.2-2' }}</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>people</mat-icon>
            <div>
              <span class="label">Direct Children</span>
              <span class="value">{{ hierarchyData?.directChildren }}</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>group_add</mat-icon>
            <div>
              <span class="label">Total Downline</span>
              <span class="value">{{ hierarchyData?.totalDownlineUsers }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div *ngIf="loading" class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading hierarchy...</p>
    </div>

    <mat-card *ngIf="!loading" class="data-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>account_tree</mat-icon>
          Hierarchy Tree
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="hierarchy-tree">
          <ng-container *ngTemplateOutlet="hierarchyTemplate; context: { nodes: hierarchyTree, level: 0 }"></ng-container>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Credit Form Modal/Card -->
  <mat-card *ngIf="showCreditForm" class="form-card credit-form">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>attach_money</mat-icon>
        Admin Credit Balance
      </mat-card-title>
      <mat-card-subtitle>Credit balance to a user (deducted from their immediate parent)</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="alert alert-info">
        <mat-icon>info</mat-icon>
        The amount will be deducted from the user's immediate parent automatically.
      </div>
      <form (ngSubmit)="adminCreditBalance()" class="form-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>User ID</mat-label>
          <input 
            matInput
            [(ngModel)]="creditUserId" 
            name="creditUserId" 
            readonly>
          <mat-icon matSuffix>fingerprint</mat-icon>
        </mat-form-field>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Amount</mat-label>
          <input 
            matInput
            type="number" 
            [(ngModel)]="creditAmount" 
            name="creditAmount"
            min="0.01"
            step="0.01"
            required>
          <span matPrefix>$&nbsp;</span>
          <mat-icon matSuffix>attach_money</mat-icon>
        </mat-form-field>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description (Optional)</mat-label>
          <textarea 
            matInput
            [(ngModel)]="creditDescription" 
            name="creditDescription"
            rows="3"></textarea>
          <mat-icon matSuffix>description</mat-icon>
        </mat-form-field>
        
        <div class="form-actions">
          <button type="submit" mat-raised-button color="accent" [disabled]="loading">
            <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
            <mat-icon *ngIf="!loading">send</mat-icon>
            Credit Balance
          </button>
          <button type="button" mat-stroked-button (click)="showCreditForm = false" [disabled]="loading">
            <mat-icon>close</mat-icon>
            Cancel
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>

<!-- Hierarchy Tree Template -->
<ng-template #hierarchyTemplate let-nodes="nodes" let-level="level">
  <ul class="hierarchy-list" [style.margin-left.px]="level * 30">
    <li *ngFor="let node of nodes" class="hierarchy-item">
      <div class="node-container">
        <button 
          *ngIf="node.children && node.children.length > 0" 
          mat-icon-button
          class="expand-btn"
          (click)="toggleNode(node)">
          <mat-icon>{{ node.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
        </button>
        <span *ngIf="!node.children || node.children.length === 0" class="expand-spacer"></span>
        
        <mat-card class="node-card">
          <mat-card-content>
            <div class="node-info">
              <div class="node-details">
                <div class="node-user">
                  <mat-icon class="user-icon">person</mat-icon>
                  <div>
                    <strong class="username">{{ node.username }}</strong>
                    <span class="email">{{ node.email }}</span>
                  </div>
                </div>
              </div>
              <div class="node-actions">
                <span class="balance-chip">
                  <mat-icon>account_balance_wallet</mat-icon>
                  ${{ node.walletBalance | number:'1.2-2' }}
                </span>
                <span class="children-chip">
                  <mat-icon>people</mat-icon>
                  {{ node.childrenCount || 0 }}
                </span>
                <button mat-icon-button color="accent" (click)="showCreditFormForUser(node._id)" matTooltip="Credit balance">
                  <mat-icon>attach_money</mat-icon>
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
      
      <div *ngIf="node.expanded && node.children && node.children.length > 0" class="children-container">
        <ng-container *ngTemplateOutlet="hierarchyTemplate; context: { nodes: node.children, level: level + 1 }"></ng-container>
      </div>
    </li>
  </ul>
</ng-template>
